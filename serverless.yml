service: dataeng-futures-wh-ingest

package:
  individually: true

provider:
  name: aws
  runtime: python3.7
  tracing:
    lambda: true
  environment:
    HANDLER: src/handler/get_futures.get_futures
    SCHEDULE: rate(3 hours)
    DYNAMODB_TABLE: ${self:service}-${opt:stage, self:provider.stage}-endpoint-hash-table
    BUCKET: ${self:service}-${opt:stage, self:provider.stage}
    XAPIKEY: 'XbiOHGfBxxvSmXBQdb6vF3gZ9P3DWUgHVmmrRpSe'
    WH_EVENT_API: 'https://odds.us.williamhill.com/api/v1/events?eventId='
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  timeout: 60

  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:GetObject
      Resource: 'arn:aws:s3:::${self:provider.environment.BUCKET}/*'
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: 'arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE}'


functions:
  # NFL
  nfl:
    handler: ${self:provider.environment.HANDLER}
    environment:
      WH_COMP_API: 'https://odds.us.williamhill.com/api/v1/events?includeMarkets=false&competitionId=007d7c61-07a7-4e18-bb40-15104b6eac92'
      ENDPOINT: 'nfl'
    events:
      - schedule: ${self:provider.environment.SCHEDULE}
  # NBA
  nba:
    handler: ${self:provider.environment.HANDLER}
    environment:
      WH_COMP_API: 'https://odds.us.williamhill.com/api/v1/events?includeMarkets=false&competitionId=5806c896-4eec-4de1-874f-afed93114b8c'
      ENDPOINT: 'nba'
    events:
      - schedule: ${self:provider.environment.SCHEDULE}
  # MLB
  mlb:
    handler: ${self:provider.environment.HANDLER}
    environment:
      WH_COMP_API: 'https://odds.us.williamhill.com/api/v1/events?includeMarkets=false&competitionId=04f90892-3afa-4e84-acce-5b89f151063d'
      ENDPOINT: 'mlb'
    events:
      - schedule: ${self:provider.environment.SCHEDULE}
  # NHL
  nhl:
    handler: ${self:provider.environment.HANDLER}
    environment:
      WH_COMP_API: 'https://odds.us.williamhill.com/api/v1/events?includeMarkets=false&competitionId=b7b715a9-c7e8-4c47-af0a-77385b525e09'
      ENDPOINT: 'nhl'
    events:
      - schedule: ${self:provider.environment.SCHEDULE}
  # NCAAF
  ncaaf:
    handler: ${self:provider.environment.HANDLER}
    environment:
      WH_COMP_API: 'https://odds.us.williamhill.com/api/v1/events?includeMarkets=false&competitionId=b7eda1b3-0170-4510-9616-1bce561d7aa7'
      ENDPOINT: 'ncaaf'
    events:
      - schedule: ${self:provider.environment.SCHEDULE}
  # NCAAB
  ncaab:
    handler: ${self:provider.environment.HANDLER}
    environment:
      WH_COMP_API: 'https://odds.us.williamhill.com/api/v1/events?includeMarkets=false&competitionId=d246a1dd-72bf-45d1-bc86-efc519fa8e90'
      ENDPOINT: 'ncaab'
    events:
      - schedule: ${self:provider.environment.SCHEDULE}

resources:
  Resources:
    nflChangeTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: dataeng-wh-futures-ingest-nfl-topic
    nbaChangeTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: dataeng-wh-futures-ingest-nba-topic
    mlbChangeTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: dataeng-wh-futures-ingest-mlb-topic
    nhlChangeTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: dataeng-wh-futures-ingest-nhl-topic
    ncaafChangeTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: dataeng-wh-futures-ingest-ncaaf-topic
    ncaabChangeTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: dataeng-wh-futures-ingest-ncaab-topic

    changeTopicPolicy:
      Type: AWS::SNS::TopicPolicy
      Properties:
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Sid: AllowUploadBucketToPushNotificationEffect
              Effect: Allow
              Principal:
                Service: s3.amazonaws.com
              Action: sns:Publish
              Resource: "*"
        Topics:
          - Ref: nbaChangeTopic
          - Ref: mlbChangeTopic
          - Ref: nflChangeTopic
          - Ref: ncaafChangeTopic
          - Ref: nhlChangeTopic
          - Ref: ncaabChangeTopic

    whBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.BUCKET}
        NotificationConfiguration:
          TopicConfigurations:
            - Event: s3:ObjectCreated:*
              Topic:
                Ref: nflChangeTopic
              Filter:
                S3Key:
                 Rules:
                    - Name: prefix
                      Value: nfl
            - Event: s3:ObjectCreated:*
              Topic:
                Ref: nbaChangeTopic
              Filter:
                S3Key:
                  Rules:
                    - Name: prefix
                      Value: nba
            - Event: s3:ObjectCreated:*
              Topic:
                Ref: mlbChangeTopic
              Filter:
                S3Key:
                  Rules:
                    - Name: prefix
                      Value: mlb
            - Event: s3:ObjectCreated:*
              Topic:
                Ref: nhlChangeTopic
              Filter:
                S3Key:
                  Rules:
                    - Name: prefix
                      Value: nhl
            - Event: s3:ObjectCreated:*
              Topic:
                Ref: ncaafChangeTopic
              Filter:
                S3Key:
                  Rules:
                    - Name: prefix
                      Value: ncaaf
            - Event: s3:ObjectCreated:*
              Topic:
                Ref: ncaabChangeTopic
              Filter:
                S3Key:
                  Rules:
                    - Name: prefix
                      Value: ncaab

    endpointHashTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE}
        AttributeDefinitions:
          -
            AttributeName: endpoint
            AttributeType: S
        KeySchema:
          -
            AttributeName: endpoint
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
